#!/usr/bin/python3

from .oled.oled_pi import OLED
from .oled.oled_window import OLEDWindow
import threading

class displayfonts(object):
    CLK = {"0" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,0x7F,0x00,0x01,0xFF,0x80,0x03,0xFF,0xC0,0x03,0xFF,0xE0,0x07,0xC3,0xE0,0x07,0x81,0xF0,0x0F,0x80,0xF0,0x0F,0x00,0xF0,0x0F,0x01,0xF8,0x0F,0x01,0xF8,0x1F,0x01,0xF8,0x1E,0x03,0xF8,0x1E,0x03,0xF8,0x1E,0x07,0x3C,0x1E,0x07,0x7C,0x1E,0x0E,0x3C,0x1E,0x0E,0x3C,0x1E,0x1C,0x3C,0x1E,0x1C,0x3C,0x1E,0x3C,0x3C,0x1E,0x38,0x3C,0x1E,0x78,0x3C,0x1E,0x70,0x3C,0x1E,0xF0,0x7C,0x1E,0xE0,0x7C,0x1F,0xE0,0x78,0x1F,0xC0,0x78,0x1F,0xC0,0x78,0x1F,0x80,0x78,0x0F,0x80,0x78,0x0F,0x00,0xF8,0x0F,0x00,0xF0,0x07,0x81,0xF0,0x07,0xC1,0xF0,0x07,0xF7,0xE0,0x03,0xFF,0xC0,0x01,0xFF,0xC0,0x00,0xFF,0x80,0x00,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "1" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x3F,0x00,0x00,0xFF,0x00,0x03,0xFF,0x00,0x07,0xFF,0x00,0x0F,0xFF,0x00,0x0F,0xCF,0x00,0x0F,0x0F,0x00,0x0E,0x0F,0x00,0x08,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x1F,0x00,0x07,0xFF,0xFC,0x07,0xFF,0xFC,0x07,0xFF,0xFC,0x07,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "2" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x03,0xFF,0x80,0x0F,0xFF,0xE0,0x1F,0xFF,0xF0,0x1F,0xFF,0xF0,0x1F,0x81,0xF8,0x1C,0x00,0xF8,0x18,0x00,0x7C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x7C,0x00,0x00,0x78,0x00,0x00,0xF8,0x00,0x00,0xF0,0x00,0x01,0xF0,0x00,0x03,0xE0,0x00,0x03,0xC0,0x00,0x07,0xC0,0x00,0x0F,0x80,0x00,0x1F,0x00,0x00,0x1E,0x00,0x00,0x3E,0x00,0x00,0x7C,0x00,0x00,0xF8,0x00,0x01,0xF0,0x00,0x01,0xE0,0x00,0x03,0xE0,0x00,0x07,0xC0,0x00,0x0F,0x80,0x00,0x1F,0x80,0x00,0x1F,0xFF,0xFE,0x1F,0xFF,0xFE,0x1F,0xFF,0xFE,0x1F,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "3" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x07,0xFF,0x00,0x0F,0xFF,0xC0,0x0F,0xFF,0xE0,0x0F,0xFF,0xF0,0x0E,0x03,0xF0,0x08,0x00,0xF8,0x00,0x00,0xF8,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0xF8,0x00,0x01,0xF0,0x00,0x0F,0xE0,0x00,0xFF,0xC0,0x00,0xFF,0x80,0x00,0xFF,0x80,0x00,0xFF,0xE0,0x00,0x03,0xF0,0x00,0x01,0xF0,0x00,0x00,0xF8,0x00,0x00,0x78,0x00,0x00,0x7C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x7C,0x00,0x00,0x78,0x10,0x00,0xF8,0x1C,0x01,0xF8,0x1F,0xFF,0xF0,0x1F,0xFF,0xE0,0x1F,0xFF,0xC0,0x0F,0xFF,0x80,0x01,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "4" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x00,0x07,0xE0,0x00,0x07,0xE0,0x00,0x0F,0xE0,0x00,0x0F,0xE0,0x00,0x1F,0xE0,0x00,0x1F,0xE0,0x00,0x39,0xE0,0x00,0x3B,0xE0,0x00,0x73,0xE0,0x00,0x73,0xE0,0x00,0xF3,0xE0,0x00,0xE3,0xE0,0x01,0xE3,0xE0,0x01,0xC3,0xE0,0x03,0xC3,0xE0,0x03,0x83,0xE0,0x07,0x83,0xE0,0x07,0x03,0xE0,0x0F,0x03,0xE0,0x0F,0x03,0xE0,0x0E,0x03,0xE0,0x1E,0x03,0xE0,0x1C,0x03,0xE0,0x3C,0x03,0xE0,0x3F,0xFF,0xFC,0x3F,0xFF,0xFE,0x3F,0xFF,0xFE,0x3F,0xFF,0xFC,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x03,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "5" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xFF,0xF0,0x0F,0xFF,0xF0,0x0F,0xFF,0xF0,0x0F,0xFF,0xF0,0x0F,0xFF,0xF0,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0xFF,0x00,0x0F,0xFF,0x80,0x0F,0xFF,0xE0,0x0F,0xFF,0xE0,0x0F,0x8F,0xF0,0x0C,0x01,0xF8,0x00,0x00,0xF8,0x00,0x00,0x78,0x00,0x00,0x7C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x7C,0x00,0x00,0x78,0x10,0x00,0xF8,0x1C,0x01,0xF0,0x1F,0xFF,0xF0,0x1F,0xFF,0xE0,0x1F,0xFF,0xC0,0x0F,0xFF,0x80,0x03,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "6" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x7F,0xE0,0x00,0xFF,0xF0,0x01,0xFF,0xF0,0x03,0xFF,0xF0,0x03,0xE0,0x70,0x07,0xC0,0x00,0x07,0x80,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x1E,0x00,0x00,0x1E,0x00,0x00,0x1E,0x00,0x00,0x1E,0x3F,0x00,0x1E,0x7F,0xC0,0x1C,0xFF,0xE0,0x1D,0xFF,0xF0,0x1F,0xE1,0xF0,0x1F,0x80,0xF8,0x1F,0x80,0x78,0x1F,0x00,0x78,0x1F,0x00,0x7C,0x1F,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x0F,0x00,0x3C,0x0F,0x00,0x7C,0x0F,0x00,0x78,0x0F,0x80,0xF8,0x07,0xC0,0xF8,0x07,0xE3,0xF0,0x03,0xFF,0xE0,0x01,0xFF,0xE0,0x00,0xFF,0xC0,0x00,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "7" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,0xFC,0x1F,0xFF,0xFC,0x1F,0xFF,0xFC,0x1F,0xFF,0xFC,0x1F,0xFF,0xF8,0x00,0x00,0x78,0x00,0x00,0xF8,0x00,0x00,0xF0,0x00,0x00,0xF0,0x00,0x00,0xF0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x03,0xE0,0x00,0x03,0xC0,0x00,0x03,0xC0,0x00,0x07,0xC0,0x00,0x07,0x80,0x00,0x07,0x80,0x00,0x0F,0x80,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x1F,0x00,0x00,0x1F,0x00,0x00,0x1E,0x00,0x00,0x3E,0x00,0x00,0x3E,0x00,0x00,0x3C,0x00,0x00,0x3C,0x00,0x00,0x7C,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0xF8,0x00,0x00,0xF0,0x00,0x00,0xF0,0x00,0x01,0xF0,0x00,0x01,0xE0,0x00,0x01,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "8" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x00,0x00,0xFF,0x80,0x03,0xFF,0xC0,0x03,0xFF,0xE0,0x07,0xFF,0xF0,0x0F,0xC1,0xF0,0x0F,0x80,0xF8,0x0F,0x00,0x78,0x0F,0x00,0x78,0x1F,0x00,0x78,0x1F,0x00,0x78,0x1F,0x00,0x78,0x0F,0x00,0x78,0x0F,0x00,0x78,0x0F,0x00,0xF0,0x07,0x80,0xF0,0x07,0xC1,0xE0,0x03,0xFF,0xC0,0x00,0xFF,0x80,0x00,0xFF,0x80,0x03,0xFF,0xE0,0x07,0xE7,0xF0,0x0F,0x80,0xF0,0x0F,0x00,0x78,0x1F,0x00,0x78,0x1E,0x00,0x7C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x3C,0x1E,0x00,0x7C,0x1F,0x00,0x7C,0x1F,0x00,0x78,0x0F,0x80,0xF8,0x0F,0xE3,0xF0,0x07,0xFF,0xF0,0x03,0xFF,0xE0,0x01,0xFF,0xC0,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           "9" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x00,0x01,0xFF,0x00,0x03,0xFF,0x80,0x07,0xFF,0xC0,0x07,0xFF,0xE0,0x0F,0x81,0xE0,0x0F,0x00,0xF0,0x1F,0x00,0xF0,0x1E,0x00,0x78,0x1E,0x00,0x78,0x1E,0x00,0x78,0x1E,0x00,0x78,0x1E,0x00,0x78,0x1E,0x00,0x78,0x1E,0x00,0x7C,0x1E,0x00,0x7C,0x1E,0x00,0x7C,0x1E,0x00,0x7C,0x1E,0x00,0xFC,0x1F,0x00,0xFC,0x0F,0x01,0xFC,0x0F,0x83,0xFC,0x07,0xFF,0xFC,0x07,0xFF,0xBC,0x03,0xFF,0x3C,0x00,0xFE,0x3C,0x00,0x00,0x38,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0x78,0x00,0x00,0xF0,0x00,0x00,0xF0,0x00,0x01,0xF0,0x06,0x03,0xE0,0x07,0xFF,0xC0,0x07,0xFF,0xC0,0x07,0xFF,0x80,0x07,0xFF,0x00,0x01,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
           ":" : [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]}

class displayOLED(object):
    oled = OLED()
    oled_win = OLEDWindow(oled,0,0,256,64)


class displayupdate(object):
    def __init__(self):
        pass
    
    def _getlinestart(self,line):
        if line == 1:
            return 47
        elif line == 2:
            return 55
        else:
            return 47
        
    def showtext(self,line,text):
        clearstr = "                                "
        threadcontrol.lock.acquire()
        threadcontrol.oled_win.draw_text(0,self._getlinestart(line),clearstr,8)
        threadcontrol.oled_win.draw_text(0,self._getlinestart(line),text,8)
        threadcontrol.oled_win.draw_screen_buffer()
        threadcontrol.lock.release()
    def cleartext(self,line):
        clearstr = "                                "
        threadcontrol.lock.acquire()
        threadcontrol.oled_win.draw_text(0,self._getlinestart(line),clearstr,8)
        threadcontrol.oled_win.draw_screen_buffer()
        threadcontrol.lock.release()

class displayhandler(object):
    def __init__(self):
        print("Setting up clock thread")
        self.clock = threading.Thread(target=self._thread_clock, args=("clock",))
        threadcontrol.threads.append(self.clock)
        print("Starting clock threads")
        self.clock.start()

    def _thread_clock(self,id):
        while True:
            now = datetime.now()
            current_time = now.strftime("%-I:%M")
            if len(current_time) == 5:
                xstart = 68
            else:
                xstart = 80
            threadcontrol.lock.acquire()
            try:
                for c in range(len(current_time)):
                    threadcontrol.oled_win.draw_bw_image(xstart,0,24,48,8,displayfonts.CLK[current_time[c]],0)
                    xstart = xstart + 24 
                threadcontrol.oled_win.draw_screen_buffer()
                threadcontrol.lock.release()
            finally:
                time.sleep(2)
